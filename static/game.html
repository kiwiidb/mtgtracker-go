<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Life Totals Over Time</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.3.1/dist/chartjs-adapter-luxon.umd.min.js"></script>

  <style>
    canvas {
      max-width: 1400px;
      height: 600px;
      margin: 50px auto;
      display: block;
      background: #23233a;
      border-radius: 20px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.25);
    }
    body {
      background: #181828;
    }
  </style>
</head>
<body>
  <canvas id="lifeChart"></canvas>

  <script>
    // Helper to get query param
    function getQueryParam(name) {
      const url = new URL(window.location.href);
      return url.searchParams.get(name);
    }

    async function fetchGameData(gameId) {
      const resp = await fetch(`/game/v1/games/${gameId}`);
      if (!resp.ok) throw new Error('Failed to fetch game');
      return await resp.json();
    }

    function buildGroupedData(events) {
      // Group by TargetPlayer, and keep a mapping for legend and event lookup
      const grouped = {};
      const playerColors = {};
      const eventMap = {}; // key: player+timestamp, value: event
      events.forEach(ev => {
        const player = ev.TargetPlayer || ev.TargetPlayerName || ev.TargetPlayerId || ev.TargetPlayer;
        if (!player) return;
        const time = new Date(ev.CreatedAt || ev.created_at).toISOString();
        if (!grouped[player]) grouped[player] = [];
        grouped[player].push({ x: time, y: ev.TargetLifeTotalAfter });
        eventMap[player + '|' + time] = ev;
      });
      return { grouped, eventMap };
    }

    function renderChart(groupedDataObj) {
      const { grouped, eventMap } = groupedDataObj;
      const colors = [
        'rgba(255,99,132,0.9)',
        'rgba(54,162,235,0.9)',
        'rgba(75,192,192,0.9)',
        'rgba(255,206,86,0.9)',
        'rgba(153,102,255,0.9)'
      ];
      const pointColors = [
        'rgba(255,99,132,1)',
        'rgba(54,162,235,1)',
        'rgba(75,192,192,1)',
        'rgba(255,206,86,1)',
        'rgba(153,102,255,1)'
      ];
      const datasets = Object.entries(grouped).map(([player, data], index) => ({
        data,
        label: player,
        fill: false,
        borderColor: colors[index % colors.length],
        backgroundColor: colors[index % colors.length],
        pointBackgroundColor: pointColors[index % pointColors.length],
        pointBorderColor: "#fff",
        pointRadius: 5,
        pointHoverRadius: 8,
        borderWidth: 4,
        tension: 0.4,
        cubicInterpolationMode: 'monotone'
      }));

      new Chart(document.getElementById('lifeChart'), {
        type: 'line',
        data: { datasets },
        options: {
          responsive: true,
          plugins: {
            legend: {
              display: true,
              labels: {
                color: '#ffd700',
                font: { size: 18, weight: 'bold' }
              }
            },
            tooltip: {
              backgroundColor: '#23233a',
              titleColor: '#ffd700',
              bodyColor: '#fff',
              borderColor: '#ffd700',
              borderWidth: 1,
              padding: 12,
              callbacks: {
                title: function() { return ''; }, // Remove timestamp
                label: function(context) {
                  // Find the event for this point
                  const player = context.dataset.label;
                  const time = new Date(context.parsed.x).toISOString();
                  const ev = eventMap[player + '|' + time];
                  if (ev && ev.SourcePlayer && ev.TargetPlayer) {
                    return `${ev.SourcePlayer} hits ${ev.TargetPlayer} for ${ev.DamageDelta}`;
                  }
                  // fallback
                  return `Life: ${context.parsed.y}`;
                }
              }
            },
            title: {
              display: true,
              text: 'Player Life Totals Over Time',
              color: '#ffd700',
              font: {
                size: 28,
                weight: 'bold'
              },
              padding: {
                top: 20,
                bottom: 30
              }
            }
          },
          layout: {
            padding: 30
          },
          scales: {
            x: {
              type: 'time',
              time: {
                tooltipFormat: 'HH:mm:ss',
                displayFormats: {
                  second: 'HH:mm:ss'
                }
              },
              grid: {
                color: '#33334d'
              },
              ticks: {
                color: '#fff',
                font: { size: 16 }
              }
            },
            y: {
              beginAtZero: true,
              grid: { color: '#33334d' },
              ticks: { color: '#fff', font: { size: 16 } }
            }
          }
        }
      });
    }

    (async function() {
      const gameId = getQueryParam('gameId');
      if (!gameId) {
        alert('No gameId specified in query params');
        return;
      }
      try {
        const game = await fetchGameData(gameId);
        const events = game.GameEvents || [];
        const groupedDataObj = buildGroupedData(events);
        renderChart(groupedDataObj);
      } catch (e) {
        alert('Failed to load game data: ' + e.message);
      }
    })();
  </script>
</body>
</html>
